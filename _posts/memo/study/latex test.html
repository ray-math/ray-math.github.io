<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>실시간 LaTeX 변환기</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <style id="dynamic-styles"></style>
  <style>
    .input-row {
      display: flex;
      align-items: center;
    }

    .input-label {
      margin-right: 5px;
    }

    textarea {
      width: 100%;
      max-width: 700px;
      box-sizing: border-box;
      font-size: 16px
    }

    .sample-size,
    .sample-color {
      cursor: pointer;
      display: inline-block;
      text-align: center;
      width: 25px;
      height: 25px;
      border-radius: 25%;
    }

    #fontSize,
    #fontColor {
      width: 100px;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h2>실시간 LaTeX 변환기 ver. 0.5</h2>
  <textarea id="latexInput" rows="4" placeholder="LaTeX 수식을 입력하세요"></textarea>
  <br />
  <div id="latexOutput"></div>
  <br />
  
  <div class="input-row">
    <label class="input-label" for="fontSize">글자 크기:</label>
    <input type="text" id="fontSize" value="16" oninput="updateOutputStyle()" />
    <div>
      <span class="sample-size" data-size="16" style="font-size: 16px;" onclick="setSampleSize(this)">16</span>
      <span class="sample-size" data-size="24" style="font-size: 16px;" onclick="setSampleSize(this)">24</span>
      <span class="sample-size" data-size="32" style="font-size: 16px;" onclick="setSampleSize(this)">32</span>
      <span class="sample-size" data-size="40" style="font-size: 16px;" onclick="setSampleSize(this)">40</span>
    </div>
  </div>

  <div class="input-row">
    <label class="input-label" for="fontColor">글자 색상:</label>
    <input type="text" id="fontColor" value="black" onchange="updateOutputStyle()" />
    <div>
      <span class="sample-color" data-color="Black" style="background-color: black;"
        onclick="setSampleColor(this)"></span>
      <span class="sample-color" data-color="Red" style="background-color: red;"
        onclick="setSampleColor(this)"></span>
      <span class="sample-color" data-color="#004D81" style="background-color: #004D81;"
        onclick="setSampleColor(this)"></span>
      <span class="sample-color" data-color="#FF9400" style="background-color: #FF9400;"
        onclick="setSampleColor(this)"></span>
    </div>
  </div>

  <button onclick="exportToPNG()">Export to PNG</button>

  <br />
  <h3>History</h3>
  <div id="history"></div>

  <script>
    const latexInput = document.getElementById('latexInput');
    const fontSizeInput = document.getElementById('fontSize');
    const fontColorInput = document.getElementById('fontColor');
    const latexOutput = document.getElementById('latexOutput');
    const historyDiv = document.getElementById('history');

    function setSampleColor(element) {
      const color = element.getAttribute('data-color');
      fontColorInput.value = color;
      updateOutputStyle();
    }
    
    function setSampleSize(element) {
      const size = element.getAttribute('data-size');
      fontSizeInput.value = size;
      updateOutputStyle();
    }

    function updateOutputStyle() {
      const fontSize = fontSizeInput.value;
      const fontColor = fontColorInput.value;

      const dynamicStyles = document.getElementById('dynamic-styles');
      dynamicStyles.textContent = `
        .mathjax-svg {
          font-size: ${fontSize}px;
          color: ${fontColor};
          background-color: transparent;
        }
      `;
    }

    function addToHistory(latex) {
      const entry = document.createElement('div');
      entry.textContent = latex;
      entry.classList.add('history-entry');
      entry.addEventListener('click', () => {
        latexInput.value = latex;
        updateLatex();
      });
      historyDiv.appendChild(entry);
    }

    latexInput.addEventListener('input', function () {
      const latex = latexInput.value;
      latexOutput.innerHTML = `<span class="mathjax-svg">$$ ${latex} $$</span>`;
      MathJax.typesetClear([latexOutput]);
      MathJax.typesetPromise([latexOutput]).catch((err) => console.log(err));
    });

    function exportToPNG() {
      const svgElement = latexOutput.querySelector('svg');
      if (!svgElement) {
        alert('Please enter the equation first.');
        return;
      }

      const latex = latexInput.value.trim();
      addToHistory(latex);

      const svgData = new XMLSerializer().serializeToString(svgElement);
      const modifiedSVGData = svgData.replace(/fill="([^"]*)"/g, `fill="${fontColorInput.value}"`);

      const blob = new Blob([modifiedSVGData], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      let img = new Image();
      img.onload = function () {
        let canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth * fontSizeInput.value;
        canvas.height = img.naturalHeight * fontSizeInput.value;
        let context = canvas.getContext('2d');
        context.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function (blob) {
          let link = document.createElement('a');
          link.download = `${latex}.png`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        }, 'image/png');
      };
      img.src = url;
    }
  </script>
</body>

</html>
